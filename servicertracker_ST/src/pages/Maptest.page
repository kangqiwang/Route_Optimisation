<apex:page controller="MapControllertest" showHeader="true" sidebar="false">
    <html>
        <head>    
            <title>Route Optimisation</title>
            <script src="./../soap/ajax/43.0/connection.js" type="text/javascript"></script>
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
            <script src="https://api.mqcdn.com/sdk/mapquest-js/v1.3.1/mapquest.js"></script>
            <link rel="stylesheet" href="https://api.mqcdn.com/sdk/mapquest-js/v1.3.1/mapquest.css"/>
            <style>
                #date_container{
                display: flex;
                justify-content: center;
                }
                
                
                
            </style>
            
            
            <script type="text/javascript">
            var resources = [];
            var territories = [];
            window.onload = function() {
                L.mapquest.key = 'XFI9f8gkExRTk58rq7jyxDSMgkgt06KV';
                
                var map = L.mapquest.map('map', {
                    center: [40.7128, -74.0059],
                    layers: L.mapquest.tileLayer('map'),
                    zoom: 13
                });
                map.addControl(L.mapquest.control());
                L.mapquest.directions().route({
                    start: '350 5th Ave, New York, NY 10118',
                    end: 'One Liberty Plaza, New York, NY 10006'
                });
                
                //generate the HTML and add name
                
                <apex:repeat value="{!objectResource}" var="resource" id="resources">
                    var pResource=document.createElement("label");
                var node=document.createTextNode('{!resource.name}');
                var element=document.getElementById("resource");
                pResource.appendChild(node);
                element.appendChild(pResource);
                var checkboxResource=document.createElement("input");
                checkboxResource.name="resource";
                checkboxResource.value='{!resource.name}';
                checkboxResource.setAttribute('type', 'checkbox');
                element.appendChild(checkboxResource);
                
                
                var resource ={
                    name: '{!resource.name}',
                };
                resources.push(resource);
                
                </apex:repeat>
                // console.log(resources);
                console.log(resources.length);
                
                <apex:repeat value="{!objectTerritory}" var="territory" id="territories">
                    var pResource=document.createElement("label");
                var node=document.createTextNode('{!territory.name}');
                var element=document.getElementById("territory");
                pResource.appendChild(node);
                element.appendChild(pResource);
                var checkboxResource=document.createElement("input");
                checkboxResource.setAttribute('type', 'checkbox');
                checkboxResource.name="territory";
                checkboxResource.value='{!territory.name}';
                element.appendChild(checkboxResource);
                
                var territory ={
                    name: '{!territory.name}'
                };
                
                territories.push(territory);

                </apex:repeat>
            }
            
            
            
            
            $(document).ready(function(){
                
                var formValue=$("#matrixForm").serializeArray();
                //js json Ajax
                $("#matrixForm").submit(function(event){
                    //var formDate=$("#fromDate").val();
                    //console.log(formValue);
                    //prevent send request
                    var rawData=$("#matrixForm").serializeArray();
                    event.preventDefault();
					
                    
                    processData(rawData);

                    // set the lantitude and longtitude
                    var locations= new Array();
                    locations[0]="51.4816, 3.1791";
                    locations[1]="51.5788, 3.2181";
                    locations[2]="51.5842,2.9977";
                    var options= new Array();
                    var allToAll=new Object();
                    
                    
                    
                    //var mappingJson=JSON.stringify({locations,options:allToAll});
                    var mappingJson = `{ "locations": [ "Cardiff, CO", "Westminster, CO", "Boulder, CO"], "options": { "allToAll": true }}`;
                    
                    $.ajax({
                        type: 'POST',
                        dataType: 'jsonp',
                        contentType: 'json',
                        url: "http://www.mapquestapi.com/directions/v2/routematrix",
                        data: {key: decodeURI("XFI9f8gkExRTk58rq7jyxDSMgkgt06KV"),
                               json: mappingJson},
                        
                        success: function(data){
                            console.log('form was submit,' + data.time);
                        },
                        error: function(data){
                            console.log("error");
                        },
                    });
                });
                
            });
            
            //input : latitude, longitude. output : show the map
            function renderMap(latitude, longitude){
                
            }
            // generate the Json file
            //input :specific date and resource, territory output: the location 
            function getLocation(data){
                
            }
            
            //input: data from the mapquest response. output: the time and distance
            function getTravelTime(data){
            	
            }
            
            //input: the raw data output: filter data using Query
            function processData(data){
                var territory=[];
                var resource=[];
                //get the resource and terrritory from the raw data
                for (i=0; i<= data.length-1; i++){
                    //console.log(i);
                    //console.log(data[i].name=="resource");
                    if(data[i].name=="territory"){
                    	territory.push(data[i].value);
                    }
                    // for example : SELECT STKR__Territory__c ,STKR__Resource_Name__c, STKR__Planned_Date__c, STKR__Account_lkp__r.STKR__Location__longitude__s, STKR__Account_lkp__r.STKR__Location__latitude__s from STKR__Visit__c where STKR__Planned_Date__c< 2019-06-19T08:26:00.000+0000 and STKR__Planned_Date__c> 2018-07-10T08:00:00.000+0000 and STKR__Resource_Name__c='Kang' and STKR__Account_lkp__r.STKR__Territory__r.Name in ('Cardiff', 'Caerphilly')
                    if (data[i].name=="resource"){
                        resource.push(data[i].value);
                    }

                    /*
                    var query="SELECT STKR__Territory__c ,STKR__Resource_Name__c, STKR__Planned_Date__c, STKR__Account_lkp__r.STKR__Location__longitude__s, STKR__Account_lkp__r.STKR__Location__latitude__s from STKR__Visit__c where STKR__Planned_Date__c< 2019-06-19T08:26:00.000+0000 and STKR__Planned_Date__c> 2018-07-10T08:00:00.000+0000 and STKR__Resource_Name__c='"+data[i].value+"' and STKR__Account_lkp__r.STKR__Territory__r.Name in ('Cardiff', 'Caerphilly')";
                    var query = "SELECT STKR__Territory__c ,STKR__Resource_Name__c, STKR__Planned_Date__c, STKR__Account_lkp__r.STKR__Location__longitude__s, STKR__Account_lkp__r.STKR__Location__latitude__s from STKR__Visit__c where STKR__Resource_Name__c ='"+data[i].value+"'";
                    try{
                        sforce.connection.sessionId="{!$Api.Session_ID}";
                        console.log("{!$Api.Session_ID}");
                        var queryResult=sforce.connection.query(query);
                        console.log(queryResult);
                    }catch(error){
                        console.log(error);
                    }
                    */
                }
                // query to find the lantitude and longtitude
                // old way is using for loop to send request one by one based on the resource and territory
                //best way is use one request get multiple resources and territories.
                for(i=0; i<= territory.length-1; i++){
                	for(j=0; j<=resource.length-1; j++){
                        var query="SELECT STKR__Planned_Date__c, STKR__Account_lkp__r.STKR__Location__longitude__s, STKR__Account_lkp__r.STKR__Location__latitude__s from STKR__Visit__c where STKR__Planned_Date__c< "+data[1].value+"T00:00:00.000+0000 and STKR__Planned_Date__c> "+data[0].value+"T00:00:00.000+0000 and STKR__Resource_Name__c='"+resource[j]+"' and STKR__Account_lkp__r.STKR__Territory__r.Name in ('"+territory[i]+"')";
                        console.log(data[1].value);
                        console.log(data[0].value);
                        console.log(resource[j]);
                        console.log(territory[i]);

                        try{
                            sforce.connection.sessionId="{!$Api.Session_ID}";
                            console.log("{!$Api.Session_ID}");
                            var queryResult=sforce.connection.query(query);
                            console.log(queryResult);
                        }catch(error){
                            console.log(error);
                        }
                    }
                }
                
                
            }
            /*
          function getdistance() {
          var mappingJson='';
          mappingJson += '{ locations: [ "Denver, CO", "Westminster, CO", "Boulder, CO"], "options": { "allToAll": true }}';
          $.ajax({
          url: 'https://www.mapquestapi.com/directions/v2/routematrix',
          crossDomain: true,
          dataType: 'jsonp',
          
          type: 'POST',
          data:{
          	key: decodeURI("XFI9f8gkExRTk58rq7jyxDSMgkgt06KV"),
          	json: JSON.stringify({ "location" : [ "Cardiff, GB", "Caerphilly, GB", "Newport, GB"], "options": { "allToAll": true}})
          },
          success: function(data){ console.log(data);},
          error: function(data) {
          	console.log('error occurred -' + data);
          },
          beforeSend: setHeader,

      });
      */
            //          var xmlhttp= new XMLHttpRequest();
            //if (this.readyState == 4 && this.status == 200) 
            //{
            //            document.getElementById("availablityResults").innerHTML=this.responseText;
            //}
            //xmlhttp.open("POST", "https://www.mapquestapi.com/directions/v2/routematrix?key=XFI9f8gkExRTk58rq7jyxDSMgkgt06KV", true);
            //xmlhttp.setRequestHeader("Content-Type", "application/json");
            //xmlhttp.send(JSON.stringify({ "location" : [ "Cardiff, GB", "Caerphilly, GB", "Newport, GB"], "options": { "allToAll": true}}));
            //console.log(xmlhttp.responseText);
            //}
            
            </script>
            
        </head>
        <body>
            <apex:pageBlock title="Route Optimisation">
                
                <form id="matrixForm" method="POST" action="http://www.mapquestapi.com/directions/v2/routematrix?key=XFI9f8gkExRTk58rq7jyxDSMgkgt06KV">
                    <div id="date_container">
                        
                        <div>
                            <label>From Date </label>
                            <input type="date" id="fromDate" name="formDate"/>    
                        </div>
                        <div style='width: 30%;'></div>
                        
                        <div style='float:left;'>
                            <label>To Date</label>
                            <input type="date" id="toDate" name="toDate"/>    
                        </div>
                    </div>
                    
                    
                    <div id="resource">
                        
                    </div>
                    
                    
                    <div id="territory">
                        
                    </div>
                    <div>
                         <input type="submit" name="submit" value="Find Nearest Tech"/>    
                    </div>
                 
                </form>
                <div id="result" style="display: none;">
                    <div class="header">
                    </div>
                    
                    <br/>
                    
                    <div id="map" style="width: 100%; height: 530px; display: none;"></div>
                    
                    <div class="individual">
                    </div>
                    <div class="route"></div>
                </div>
            </apex:pageBlock>
        </body>
    </html>
</apex:page>